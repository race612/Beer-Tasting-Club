<!DOCTYPE html>
<html lang="it">
<head>
    <link rel="manifest" href="/HBL-Tasting/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HBL Tasting">
    <link rel="apple-touch-icon" href="assets/logo-hbl.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuova Degustazione - HBL</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="module" src="js/app.js"></script>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="assets/logo-hbl.png" alt="Logo" style="width: 60px;">
            <h3>Nuova Scheda</h3>
        </div>

        <div class="card">
            <form id="setup-form">
                
                <label style="margin-bottom: 10px; display:block;">Cosa stiamo bevendo?</label>
                <div class="mode-switch">
                    <div class="mode-option active" id="mode-free" onclick="setMode('free')">
                        üè† Libera / Privata
                    </div>
                    <div class="mode-option" id="mode-event" onclick="setMode('event')">
                        üìÖ Evento HBL
                    </div>
                </div>

                <div class="form-group" id="event-selector-group" style="display: none;">
                    <label for="evento-select">Seleziona la serata:</label>
                    <select id="evento-select">
                        <option value="">Caricamento eventi...</option>
                    </select>
                </div>

                <input type="hidden" id="final-event-id">

                <hr style="border: 0; border-top: 1px solid #374151; margin: 20px 0;">

                <div class="form-group">
                    <label>üìù Che scheda usi?</label>
                    <div class="grid-2">
                        <div class="selection-card" onclick="selectCard(this, 'bjcp-sintetica')">
                            <h4 style="font-size: 1.5rem;">üìú</h4>
                            <h4>BJCP Sintetica</h4>
                            <p>Veloce e precisa</p>
                        </div>
                        
                        <div class="selection-card" onclick="selectCard(this, 'hbl-classica')">
                            <h4 style="font-size: 1.5rem;">üç∫</h4>
                            <h4>Scheda HBL</h4>
                            <p>Standard Club</p>
                        </div>
                        
                        <div class="selection-card" onclick="selectCard(this, 'crocette')">
                            <h4 style="font-size: 1.5rem;">‚ùå</h4>
                            <h4>Crocette</h4>
                            <p>Super rapida</p>
                        </div>

                        <div class="selection-card" onclick="selectCard(this, 'bjcp-full')">
                            <h4 style="font-size: 1.5rem;">‚öñÔ∏è</h4>
                            <h4>BJCP Full</h4>
                            <p>Esame completo</p>
                        </div>
                    </div>
                    
                    <input type="hidden" id="tipo-scheda" required>
                    <p id="selection-error" style="color: var(--danger); display: none; margin-top: 15px; font-weight: bold;">‚ö†Ô∏è Seleziona un tipo di scheda per proseguire</p>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">Inizia Degustazione ‚Üí</button>
                </div>
            </form>
        </div>

        <a href="index.html" class="link-back">‚Üê Torna alla Dashboard</a>
    </div>

    <script type="module">
        import { supabase } from './js/supabase-config.js';

        let freeEventId = null; // ID evento Libero

        // 1. Carica Eventi
        async function loadEvents() {
            const select = document.getElementById('evento-select');
            
            const { data: events, error } = await supabase
                .from('events')
                .select('id, name')
                .eq('is_active', true)
                .order('id', { ascending: false });

            if (error) {
                console.error('Errore eventi:', error);
                return;
            }

            select.innerHTML = '<option value="" disabled selected>-- Scegli Evento --</option>';
            
            events.forEach(event => {
                const nameLower = event.name.toLowerCase();
                if (nameLower.includes('libero') || nameLower.includes('privato')) {
                    freeEventId = event.id;
                } else {
                    const option = document.createElement('option');
                    option.value = event.id;
                    option.textContent = event.name;
                    select.appendChild(option);
                }
            });
        }

        loadEvents();

        // 2. Gestione Tabs (Modalit√†)
        window.setMode = function(mode) {
            const btnEvent = document.getElementById('mode-event');
            const btnFree = document.getElementById('mode-free');
            const selectorGroup = document.getElementById('event-selector-group');
            const select = document.getElementById('evento-select');

            if (mode === 'event') {
                // Attiva Evento
                btnEvent.classList.add('active');
                btnFree.classList.remove('active');
                selectorGroup.style.display = 'block'; 
                select.required = true;
            } else {
                // Attiva Libero
                btnFree.classList.add('active');
                btnEvent.classList.remove('active');
                selectorGroup.style.display = 'none'; 
                select.required = false;
                select.value = ""; 
            }
        }

        // 3. Selezione Scheda Grafica
        window.selectCard = function(element, value) {
            document.querySelectorAll('.selection-card').forEach(el => {
                el.style.border = '2px solid transparent';
                el.style.backgroundColor = 'var(--card-bg)';
            });
            element.style.borderColor = 'var(--primary-color)';
            element.style.backgroundColor = '#2d3748';
            document.getElementById('tipo-scheda').value = value;
            document.getElementById('selection-error').style.display = 'none';
        }

        // 4. Invio Form
        document.getElementById('setup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const isFreeMode = document.getElementById('mode-free').classList.contains('active');
            let finalId = null;

            if (isFreeMode) {
                if (!freeEventId) {
                    alert("Errore tecnico: Non trovo l'ID 'Libero' nel database.");
                    return;
                }
                finalId = freeEventId;
            } else {
                finalId = document.getElementById('evento-select').value;
                if (!finalId) {
                    alert("Seleziona una serata dal menu!");
                    return;
                }
            }

            const tipoScheda = document.getElementById('tipo-scheda').value;
            if (!tipoScheda) {
                document.getElementById('selection-error').style.display = 'block';
                return;
            }

            localStorage.setItem('hbl_selected_event', finalId);
            window.location.href = `schede/${tipoScheda}.html`;
        });
    </script>
</body>
</html>