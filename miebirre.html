<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le mie Birre - Beer Tasting Club</title>
    <link rel="stylesheet" href="css/style.css?v=0.8.1">
    <link rel="manifest" href="/Beer-Tasting-Club/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
</head>
<body>
    <div class="container">
        
        <div class="header-bar">
            <div id="dynamic-back-btn" class="header-link" style="cursor: pointer;">
                <span class="material-symbols-outlined">arrow_back</span> <span id="back-label">Home</span>
            </div>
            <img src="assets/logo.png" alt="Logo" class="header-logo">
        </div>

        <h2 class="text-center" style="margin-bottom: 5px;" id="page-title">Le mie Birre</h2>
        <p class="text-center" style="color: var(--text-muted); font-size: 0.9em; margin-top:0;" id="page-subtitle">Archivio produzioni e cantina</p>

        <div id="view-list" style="margin-top: 20px; padding-bottom: 60px;">
            <div id="beer-list-container">
                <p style="text-align: center; margin-top: 40px;">Caricamento...</p>
            </div>
        </div>

        <div id="view-add" style="display: none; margin-top: 20px;">
            <div class="card">
                <form id="beer-form">
                    <input type="hidden" id="edit-beer-id"> 

                    <div class="form-group">
                        <label>Nome Birra</label>
                        <input type="text" id="beer-name" required placeholder="Es. American IPA">
                    </div>

                    <div class="form-group">
                        <label>Produttore / Birrificio</label>
                        <input type="text" id="beer-producer" required placeholder="Es. Mario Rossi">
                        
                        <div class="chips-grid" id="group-producer-type">
                            <div class="chip-btn" data-value="homebrewer">Homebrewer</div>
                            <div class="chip-btn" data-value="pro">Professionale</div>
                        </div>
                    </div>

                    <hr style="border-color: #374151; margin: 20px 0;">

                    <div class="form-group">
                        <label>Stile</label>
                        <select id="style-system" style="margin-bottom: 10px; border: 1px solid var(--primary-color);">
                            <option value="free">üìù Stile Libero</option>
                            <option value="bjcp">‚öñÔ∏è BJCP 2021</option>
                        </select>

                        <div id="container-free">
                            <input type="text" id="style-free" placeholder="Es. Italian Grape Ale" minlength="3">
                        </div>

                        <div id="container-bjcp" style="display: none;">
                            <select id="style-bjcp">
                                <option value="" disabled selected>-- Seleziona uno stile --</option>
                            </select>
                            <div id="bjcp-dynamic-container"></div>
                        </div>
                    </div>

                    <hr style="border-color: #374151; margin: 20px 0;">

                    <div class="form-group">
                        <label>Confezionamento (Opzionale)</label>
                        <div class="chips-grid" id="group-packaging">
                            <div class="chip-btn" data-value="bottle">Bottiglia</div>
                            <div class="chip-btn" data-value="can">Lattina</div>
                            <div class="chip-btn" data-value="tap">Spina</div>
                            <div class="chip-btn" data-value="growler">Growler</div>
                        </div>
                    </div>

                    <button type="submit" id="btn-save" class="btn btn-primary" style="margin-top: 20px;">
                        <span class="material-symbols-outlined">save</span> Salva Birra
                    </button>
                </form>
            </div>
        </div>

        <button class="fab-add" id="fab-add" onclick="openForm()">
            <span class="material-symbols-outlined" style="font-size: 2rem;">add</span>
        </button>

        <footer style="text-align: center; margin-top: 40px; font-size: 1rem; color: #4b5563;">
            &copy; 2026 Beer Tasting Club <span class="footer-ver" id="footer-version">v...</span><br>
            <a href="privacy.html" style="color: inherit; text-decoration: underline;">Info Privacy e Cookie</a>
            <p style="text-align: center; margin-top: 5px; font-size: 0.7rem; color: #4b5563; display: flex; align-items: center; justify-content: center; gap: 4px;">
                Crafted with love by <a href="https://www.linkedin.com/in/mirko-caiani/" target="_blank" style="color: inherit; text-decoration: underline;">Mirko Caiani</a>
            </p>
        </footer>
    </div>

    <div id="update-toast" class="update-toast">
        <span class="material-symbols-outlined">system_update</span>
        Nuova versione! Clicca qui.
    </div>

    <script type="module">
        import { supabase } from './js/supabase-config.js';
        import { bjcpCatalog, specialStyleRules } from './js/bjcp-2021.js';
        import { APP_VERSION } from './js/config.js';
        import { showModal } from './js/modal.js';

        // 1. Footer Version
        document.getElementById('footer-version').textContent = ` v${APP_VERSION}`;

        // 2. Chip Helper
        function setupChipGroup(groupId) {
            const container = document.getElementById(groupId);
            container.querySelectorAll('.chip-btn').forEach(chip => {
                chip.addEventListener('click', () => {
                    if (chip.classList.contains('selected')) {
                        chip.classList.remove('selected');
                    } else {
                        container.querySelectorAll('.chip-btn').forEach(c => c.classList.remove('selected'));
                        chip.classList.add('selected');
                    }
                });
            });
        }
        setupChipGroup('group-producer-type');
        setupChipGroup('group-packaging');

        function getChipValue(groupId) {
            const el = document.getElementById(groupId).querySelector('.chip-btn.selected');
            return el ? el.getAttribute('data-value') : null;
        }
        function setChipValue(groupId, val) {
            const el = document.querySelector(`#${groupId} .chip-btn[data-value="${val}"]`);
            if(el) el.classList.add('selected');
        }

        // 3. BJCP Logic
        const systemSelect = document.getElementById('style-system');
        const containerFree = document.getElementById('container-free');
        const containerBjcp = document.getElementById('container-bjcp');
        const inputFree = document.getElementById('style-free');
        const inputBjcp = document.getElementById('style-bjcp');
        const dynamicContainer = document.getElementById('bjcp-dynamic-container');

        bjcpCatalog.forEach(category => {
            const group = document.createElement('optgroup');
            group.label = category.family;
            category.styles.forEach(styleName => {
                const option = document.createElement('option');
                option.value = styleName; option.textContent = styleName;
                group.appendChild(option);
            });
            inputBjcp.appendChild(group);
        });

        systemSelect.addEventListener('change', (e) => {
            if (e.target.value === 'free') {
                containerFree.style.display = 'block'; 
                inputFree.setAttribute('required', 'true');
                containerBjcp.style.display = 'none'; 
                inputBjcp.removeAttribute('required');
            } else {
                containerBjcp.style.display = 'block'; 
                inputBjcp.setAttribute('required', 'true');
                containerFree.style.display = 'none'; 
                inputFree.removeAttribute('required');
            }
        });

        inputBjcp.addEventListener('change', (e) => {
            dynamicContainer.innerHTML = ''; 
            const code = e.target.value.split('.')[0];
            const rule = specialStyleRules[code];
            if (!rule) return;
            const wrapper = document.createElement('div');
            if (rule.type === 'text_only') {
                 wrapper.innerHTML += `<input type="text" id="dyn-text" placeholder="${rule.placeholder||'...'}" style="width:100%; padding:10px; margin-top:5px; background:#111827; border:1px solid #4b5563; color:white; border-radius:4px;">`;
            } else if (rule.type === 'options') {
                wrapper.innerHTML += `<div style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap;">` + 
                rule.choices.map(c => `<label style="background:#111827; padding:5px 10px; border-radius:4px;"><input type="radio" name="dyn-radio" value="${c}"> ${c}</label>`).join('') + `</div>`;
            }
            dynamicContainer.appendChild(wrapper);
        });

        // 4. Form Logic
        let currentView = 'list'; 

        window.openForm = function(beerToEdit = null) {
            currentView = 'form';
            updateNav();
            
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-add').style.display = 'block';
            document.getElementById('fab-add').style.display = 'none';
            document.getElementById('page-title').textContent = beerToEdit ? "Modifica Birra" : "Nuova Birra";
            document.getElementById('page-subtitle').style.display = 'none';

            // RESET
            document.getElementById('beer-form').reset();
            document.getElementById('edit-beer-id').value = "";
            document.querySelectorAll('.chip-btn').forEach(c => c.classList.remove('selected'));
            document.getElementById('style-system').value = 'free';
            document.getElementById('style-system').dispatchEvent(new Event('change'));

            if (beerToEdit) {
                // POPULATE
                document.getElementById('edit-beer-id').value = beerToEdit.id;
                document.getElementById('beer-name').value = beerToEdit.name;
                document.getElementById('beer-producer').value = beerToEdit.producer;
                
                if (beerToEdit.producer_type) setChipValue('group-producer-type', beerToEdit.producer_type);
                if (beerToEdit.packaging) setChipValue('group-packaging', beerToEdit.packaging);

                document.getElementById('style-system').value = beerToEdit.style_type;
                document.getElementById('style-system').dispatchEvent(new Event('change'));
                
                if (beerToEdit.style_type === 'free') {
                    document.getElementById('style-free').value = beerToEdit.style_name;
                } else {
                    document.getElementById('style-bjcp').value = beerToEdit.style_name;
                    document.getElementById('style-bjcp').dispatchEvent(new Event('change'));
                }
            }
        }

        window.closeForm = function() {
            currentView = 'list';
            updateNav();
            document.getElementById('view-list').style.display = 'block';
            document.getElementById('view-add').style.display = 'none';
            document.getElementById('fab-add').style.display = 'flex';
            document.getElementById('page-title').textContent = "Le mie Birre";
            document.getElementById('page-subtitle').style.display = 'block';
            
            loadBeers(); // IMPORTANT: Refresh list
        }

        function updateNav() {
            const btn = document.getElementById('dynamic-back-btn');
            const label = document.getElementById('back-label');
            if (currentView === 'form') {
                label.textContent = "Mie Birre";
                btn.onclick = () => closeForm();
            } else {
                label.textContent = "Home";
                btn.onclick = () => window.location.href = 'index.html';
            }
        }
        updateNav(); 

        // 5. Sharing ID & Copy
        function generateSharingId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
            return result;
        }

        window.copyId = async function(id, event) {
            event.stopPropagation();
            navigator.clipboard.writeText(id).then(() => {
                showModal("Copiato!", "ID copiato negli appunti: " + id, "success", "content_copy");
            });
        }

        // 6. LOAD BEERS
        async function loadBeers() {
            const container = document.getElementById('beer-list-container');
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }

            const { data: beers, error } = await supabase
                .from('my_beers')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) { container.innerHTML = `<p style="color:red;">Errore: ${error.message}</p>`; return; }
            if (!beers || beers.length === 0) {
                container.innerHTML = `<p style="text-align: center; opacity: 0.6;">Nessuna birra inserita.<br>Clicca su + per iniziare.</p>`;
                return;
            }

            container.innerHTML = '';
            
            const packMap = { 'bottle': 'Bottiglia', 'can': 'Lattina', 'tap': 'Spina', 'growler': 'Growler' };

            beers.forEach(beer => {
                const el = document.createElement('div');
                el.className = 'beer-card';
                
                const producerText = beer.producer + (beer.producer_type === 'homebrewer' ? ' (Homebrewer)' : '');
                const packText = beer.packaging ? packMap[beer.packaging] : '';

                el.innerHTML = `
                    <div class="beer-header">
                        <div>
                            <h3 style="margin:0; color:white;">${beer.name}</h3>
                            <div class="beer-producer">${producerText}</div>
                            ${packText ? `<div class="beer-packaging">${packText}</div>` : ''}
                        </div>
                        <div class="beer-id-badge" onclick="copyId('${beer.sharing_id}', event)" title="Clicca per copiare">
                            <span class="material-symbols-outlined" style="font-size:0.9rem">content_copy</span>
                            ${beer.sharing_id}
                        </div>
                    </div>
                    
                    <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:flex-end;">
                        <div style="font-size:0.9rem; color:var(--primary-color); font-weight:bold;">
                            ${beer.style_name}
                        </div>
                        <div style="display:flex; gap:15px;">
                            <button class="btn-action-beer" id="edit-${beer.id}" style="background:none; border:none; color:#f59e0b; cursor:pointer;">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button class="btn-action-beer" id="del-${beer.id}" style="background:none; border:none; color:#ef4444; cursor:pointer;">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </div>
                `;

                el.addEventListener('click', (e) => {
                    if(e.target.closest('.btn-action-beer') || e.target.closest('.beer-id-badge')) return;
                    window.location.href = `dettaglio-birra.html?id=${beer.id}`;
                });

                el.querySelector(`#edit-${beer.id}`).addEventListener('click', (e) => {
                    e.stopPropagation();
                    openForm(beer);
                });

                el.querySelector(`#del-${beer.id}`).addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const proceed = await showModal("Elimina Birra", "Eliminare questa birra?", "confirm", "delete");
                    if(proceed) {
                        await supabase.from('my_beers').delete().eq('id', beer.id);
                        loadBeers();
                    }
                });

                container.appendChild(el);
            });
        }

        // 7. SAVE BEER
        document.getElementById('beer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.textContent = "Salvataggio...";

            const { data: { user } } = await supabase.auth.getUser();
            const editId = document.getElementById('edit-beer-id').value;

            // Stile Logic
            let styleName = "";
            let styleDetails = null;
            if (systemSelect.value === 'free') styleName = document.getElementById('style-free').value;
            else {
                styleName = inputBjcp.value;
                const textVal = document.getElementById('dyn-text')?.value;
                const radioVal = document.querySelector('input[name="dyn-radio"]:checked')?.value;
                let detailsArr = [];
                if(textVal) detailsArr.push(textVal);
                if(radioVal) detailsArr.push(radioVal);
                if(detailsArr.length > 0) styleDetails = detailsArr.join(', ');
            }

            const basePayload = {
                name: document.getElementById('beer-name').value,
                producer: document.getElementById('beer-producer').value,
                producer_type: getChipValue('group-producer-type'),
                style_type: systemSelect.value,
                style_name: styleName,
                style_details: styleDetails,
                packaging: getChipValue('group-packaging')
            };

            let error = null;

            if (editId) {
                // UPDATE (Solo dati, no ID)
                const res = await supabase.from('my_beers').update(basePayload).eq('id', editId);
                error = res.error;
            } else {
                // INSERT
                let sharingId = generateSharingId();
                let unique = false; let attempts = 0;
                while(!unique && attempts < 5) {
                    const { data } = await supabase.from('my_beers').select('id').eq('sharing_id', sharingId);
                    if (!data || data.length === 0) unique = true;
                    else { sharingId = generateSharingId(); attempts++; }
                }

                const insertPayload = { ...basePayload, user_id: user.id, sharing_id: sharingId };
                const res = await supabase.from('my_beers').insert([insertPayload]);
                error = res.error;
            }

            if (error) {
                await showModal("Errore", "Errore: " + error.message, "error");
                btn.disabled = false; btn.innerHTML = `<span class="material-symbols-outlined">save</span> Salva Birra`;
            } else {
                closeForm(); // Ricarica la lista
                btn.disabled = false; btn.innerHTML = `<span class="material-symbols-outlined">save</span> Salva Birra`;
            }
        });

        loadBeers();

        // 8. SW Update
        const updateToast = document.getElementById('update-toast');
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                if (reg.waiting) if(updateToast) updateToast.classList.add('show');
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if(updateToast) updateToast.classList.add('show');
                        }
                    });
                });
            });
        }
        if(updateToast) updateToast.addEventListener('click', () => window.location.reload());
    </script>
</body>
</html>