<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le mie Degustazioni - HBL</title>
    <link rel="stylesheet" href="css/style.css">
    
    <link rel="manifest" href="/HBL-Tasting/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <script type="module" src="js/app.js"></script>
</head>
<body>
    <div class="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <a href="index.html" style="text-decoration: none; font-size: 1.5rem;">üè†</a>
            <h3>Il mio Storico</h3>
            <div style="width: 30px;"></div>
        </div>

        <div id="history-container">
            <p style="text-align: center; color: var(--text-muted);">Caricamento schede...</p>
        </div>

        <br>
        <a href="index.html" class="link-back">‚Üê Torna alla Dashboard</a>
    </div>

    <script type="module">
        import { supabase } from './js/supabase-config.js';

        const container = document.getElementById('history-container');

        // Funzione per caricare lo storico
        async function loadHistory() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                container.innerHTML = '<p>Devi essere loggato.</p>';
                return;
            }

            const { data: notes, error } = await supabase
                .from('tasting_notes')
                .select('*, events(name)') 
                .eq('user_id', user.id) 
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = `<p style="color:red">Errore caricamento: ${error.message}</p>`;
                return;
            }

            if (notes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p>Non hai ancora compilato nessuna scheda!</p>
                        <a href="nuova-scheda.html" class="btn btn-primary">üç∫ Inizia ora</a>
                    </div>`;
                return;
            }

            container.innerHTML = ''; 
            
            notes.forEach(note => {
                const style = note.details.style || "Stile non spec.";
                const date = new Date(note.created_at).toLocaleDateString('it-IT');
                const eventName = note.events ? note.events.name : "";
                const isFreeEvent = eventName.toLowerCase().includes('libero') || eventName.toLowerCase().includes('privato');
                
                let borderClass = '';
                if (note.final_score >= 45) borderClass = 'border-gold';
                else if (note.final_score >= 38) borderClass = 'border-green';
                else if (note.final_score < 30) borderClass = 'border-red';

                const html = `
                    <div class="history-card ${borderClass}">
                        
                        <button class="delete-btn" onclick="window.deleteNote('${note.id}', event)">
                            üóëÔ∏è
                        </button>

                        <a href="dettaglio-scheda.html?id=${note.id}" style="text-decoration: none; color: inherit; display: block; padding-right: 30px;">
                            <div class="history-header">
                                <div>
                                    <h4 class="beer-name">${note.beer_name}</h4>
                                    <span class="beer-style">${style}</span>
                                </div>
                                <div class="score-badge">
                                    ${note.final_score}
                                </div>
                            </div>
                            
                            <div class="meta-info">
                                <span>üìÖ ${date}</span>
                                ${!isFreeEvent ? `<span>üìç ${eventName}</span>` : ''}
                            </div>
                            
                            <div style="margin-top: 8px;">
                                <span style="background: #374151; color: #9ca3af; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; text-transform: uppercase;">
                                    ${note.sheet_type.replace('_', ' ')}
                                </span>
                            </div>
                        </a>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // Funzione Eliminazione Globale
        window.deleteNote = async function(id, event) {
            event.preventDefault();
            event.stopPropagation();

            if(!confirm("‚ö†Ô∏è Sei sicuro di voler eliminare questa scheda?\nL'operazione non √® reversibile.")) {
                return;
            }

            const { error } = await supabase
                .from('tasting_notes')
                .delete()
                .eq('id', id);

            if (error) {
                alert("Errore durante l'eliminazione: " + error.message);
            } else {
                loadHistory(); // Ricarica la lista pulita
            }
        }

        loadHistory();
    </script>
</body>
</html>