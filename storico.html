<!DOCTYPE html>
<html lang="it">
<head>
    <link rel="manifest" href="/HBL-Tasting/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HBL Tasting">
    <link rel="apple-touch-icon" href="assets/logo-hbl.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le mie Degustazioni - HBL</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="module" src="js/app.js"></script>
</head>
<body>
    <div class="container">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <a href="index.html" style="text-decoration: none; font-size: 1.5rem;">üè†</a>
            <h3>Il mio Storico</h3>
            <div style="width: 30px;"></div> </div>

        <div id="history-container">
            <p style="text-align: center; color: var(--text-muted);">Caricamento schede...</p>
        </div>

        <br>
        <a href="index.html" class="link-back">‚Üê Torna alla Dashboard</a>
    </div>

    <style>
        .history-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid var(--primary-color); /* Riga colorata a sinistra */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        .beer-name { font-size: 1.2rem; font-weight: bold; color: white; margin: 0; }
        .beer-style { font-size: 0.9rem; color: var(--text-muted); font-style: italic; }
        
        .score-badge {
            background: #111827;
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
            border: 1px solid #374151;
        }

        .meta-info {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #374151;
            padding-top: 8px;
        }

        /* Colori dinamici per il bordo sinistro in base al voto */
        .border-green { border-left-color: #10b981; }
        .border-gold { border-left-color: #FFD700; }
        .border-red { border-left-color: #ef4444; }
    </style>

    <script type="module">
        import { supabase } from './js/supabase-config.js';

        const container = document.getElementById('history-container');

        async function loadHistory() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                container.innerHTML = '<p>Devi essere loggato.</p>';
                return;
            }

            const { data: notes, error } = await supabase
                .from('tasting_notes')
                .select('*, events(name)') 
                .eq('user_id', user.id) 
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = `<p style="color:red">Errore: ${error.message}</p>`;
                return;
            }

            if (notes.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 20px;"><p>Nessuna scheda.</p><a href="nuova-scheda.html" class="btn btn-primary">üç∫ Inizia ora</a></div>`;
                return;
            }

            container.innerHTML = ''; 
            
            notes.forEach(note => {
                const style = note.details.style || "Stile non spec.";
                const date = new Date(note.created_at).toLocaleDateString('it-IT');
                
                // GESTIONE VISIBILIT√Ä EVENTO
                const eventName = note.events ? note.events.name : "";
                const isFreeEvent = eventName.toLowerCase().includes('libero') || eventName.toLowerCase().includes('privato');
                
                let borderClass = '';
                if (note.final_score >= 45) borderClass = 'border-gold';
                else if (note.final_score >= 38) borderClass = 'border-green';
                else if (note.final_score < 30) borderClass = 'border-red';

                const html = `
                    <a href="dettaglio-scheda.html?id=${note.id}" style="text-decoration: none; color: inherit;">
                        <div class="history-card ${borderClass}">
                            <div class="history-header">
                                <div>
                                    <h4 class="beer-name">${note.beer_name}</h4>
                                    <span class="beer-style">${style}</span>
                                </div>
                                <div class="score-badge">
                                    ${note.final_score}
                                </div>
                            </div>
                            
                            <div class="meta-info">
                                <span>üìÖ ${date}</span>
                                ${!isFreeEvent ? `<span>üìç ${eventName}</span>` : ''}
                            </div>
                            
                            <div style="margin-top: 8px;">
                                <span style="background: #374151; color: #9ca3af; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; text-transform: uppercase;">
                                    ${note.sheet_type.replace('_', ' ')}
                                </span>
                            </div>
                        </div>
                    </a>
                `;
                container.innerHTML += html;
            });
        }
        loadHistory();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/HBL-Tasting/sw.js')
                    .then(registration => {
                        console.log('SW registrato con successo:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW fallito:', error);
                    });
            });
        }
    </script>
</body>
</html>