<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - Beer Tasting Club</title>
    <link rel="stylesheet" href="css/style.css?v=0.8.1">
    <link rel="manifest" href="/Beer-Tasting-Club/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <style>
        /* STILI SPECIFICI PER PROFILO */
        .profile-section-title {
            color: var(--primary-color);
            border-bottom: 1px solid #374151;
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Testo grigino per le label */
        .text-muted-small {
            color: var(--text-muted);
            font-size: 0.85em;
            font-weight: normal;
            margin-left: 5px;
        }

        /* Griglia Pulsanti (Chips) */
        .chips-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* Layout a colonna singola per testi lunghi (BJCP/Ruoli) */
        .chips-grid.full-width {
            grid-template-columns: 1fr; 
        }

        /* Su tablet/desktop rimettiamo 2 colonne se c'è spazio */
        @media (min-width: 600px) {
            .chips-grid.full-width { grid-template-columns: 1fr 1fr; }
        }
        
        .chip-btn {
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 12px 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            user-select: none;
            line-height: 1.2;
        }

        .chip-btn:hover {
            border-color: #9ca3af;
            background: #374151;
        }

        .chip-btn.selected {
            background: rgba(245, 158, 11, 0.15); /* Ambra trasparente */
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.2);
        }

        /* Campi Condizionali (Container nascosti) */
        .conditional-container {
            margin-top: 15px;
            background: #374151;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            animation: fadeIn 0.3s ease-out;
            display: none;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="header-bar">
            <a href="index.html" class="header-link">
                <span class="material-symbols-outlined">arrow_back</span> Home
            </a>
            <img src="assets/logo.png" alt="Logo" class="header-logo">
        </div>

        <div class="card">
            
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <div class="profile-avatar" id="avatar-initials" style="margin-bottom: 15px;">?</div>
                
                <div style="width: 100%; text-align: left;">
                    <div class="form-group">
                        <label>Nome Pubblico <span class="text-muted-small">(Nome e Cognome o Nickname)</span></label>
                        <input type="text" id="display-name" placeholder="Il tuo nome">
                    </div>
                    <div class="form-group">
                        <label>Email <span class="text-muted-small">(Non modificabile)</span></label>
                        <input type="email" id="user-email" disabled style="opacity: 0.6; cursor: not-allowed; color: #9ca3af;">
                    </div>
                </div>
            </div>

            <h3 class="profile-section-title">Homebrewer</h3>
            <div style="margin-bottom: 15px;">
                <label style="margin-bottom: 10px; display:block;">Sei un Birraio Casalingo?</label>
                <div class="chips-grid" id="hb-bool-grid">
                    <div class="chip-btn" data-value="yes">Sì</div>
                    <div class="chip-btn selected" data-value="no">No</div> </div>
            </div>

            <div id="hb-club-container" class="conditional-container">
                <label style="color: #d1d5db; font-size: 0.9rem; margin-bottom: 8px; display:block;">Fai parte di un'associazione o un club?</label>
                <select id="hb-club-select">
                    <option value="solitario">No, sono solitario</option>
                    <option value="passato">No, ma ne ho fatto parte in passato</option>
                    <option value="HBL">HBL - HomeBrewers Lombardi</option>
                    <option value="HBS">HBS - HomeBrewers Sardi</option>
                    <option value="AHBT">AHBT - Associazione HomeBrewers Ticino</option>
                    <option value="ABC">ABC - Associazione Birraria Cuneese</option>
                </select>
            </div>


            <h3 class="profile-section-title">Qualifiche & Ruoli</h3>
            <div class="chips-grid full-width" id="roles-grid">
                <div class="chip-btn" data-role="role_pro">Birraio Professionista</div>
                <div class="chip-btn" data-role="role_publican">Publican</div>
                <div class="chip-btn" data-role="role_ubt">UBT - UnionBirrai Beer Taster</div>
                <div class="chip-btn" data-role="role_doemens">Bier Sommelier Doemens</div>
                <div class="chip-btn" data-role="role_ais">Sommelier AIS della birra</div>
                <div class="chip-btn" data-role="role_dieffe">Beer Sommelier Dieffe</div>
                <div class="chip-btn" data-role="role_other_assoc">Beer Sommelier - Altre associazioni</div>
                <div class="chip-btn" data-role="role_courses">Altri corsi di degustazione</div>
            </div>


            <h3 class="profile-section-title">Livello BJCP</h3>
            <div class="chips-grid full-width" id="bjcp-grid">
                <div class="chip-btn" data-value="provisional">Provisional Judge</div>
                <div class="chip-btn" data-value="pending">Rank Pending</div>
                <div class="chip-btn" data-value="apprentice">Apprentice Judge</div>
                <div class="chip-btn" data-value="recognized">Recognized Judge</div>
                <div class="chip-btn" data-value="certified">Certified Judge</div>
                <div class="chip-btn" data-value="national">National Judge</div>
                <div class="chip-btn" data-value="master">Master Judge</div>
                <div class="chip-btn" data-value="grand_master">Grand Master Judge</div>
            </div>

            <div id="bjcp-id-container" class="conditional-container">
                <label style="color: #d1d5db; font-size: 0.9rem;">Il tuo ID BJCP</label>
                <input type="text" id="bjcp-id" placeholder="Es. E1234" style="margin-top: 5px;">
            </div>


            <h3 class="profile-section-title">Livello Cicerone®</h3>
            <div class="chips-grid full-width" id="cicerone-grid">
                <div class="chip-btn" data-value="server">Certified Beer Server</div>
                <div class="chip-btn" data-value="certified">Certified Cicerone</div>
                <div class="chip-btn" data-value="advanced">Advanced Cicerone</div>
                <div class="chip-btn" data-value="master">Master Cicerone</div>
            </div>

            <div id="cicerone-link-container" class="conditional-container">
                <label style="color: #d1d5db; font-size: 0.9rem;">Link al profilo Cicerone</label>
                <input type="url" id="cicerone-link" placeholder="https://www.cicerone.org/..." style="margin-top: 5px;">
            </div>


            <button id="save-profile" class="btn btn-primary mt-20">
                <span class="material-symbols-outlined">save</span> Salva Profilo
            </button>
        </div>

        <button id="logout-btn" class="btn btn-danger-outline mt-20">
            <span class="material-symbols-outlined">logout</span> Esci dall'App
        </button>
    </div>

    <footer style="text-align: center; margin-top: 40px; font-size: 1rem; color: #4b5563;">
        &copy; 2026 Beer Tasting Club - 
        <a href="privacy.html" style="color: inherit; text-decoration: underline;">Info Privacy e Cookie</a>
        
        <p style="text-align: center; margin-top: 5px; font-size: 0.6rem; color: #4b5563;">
            Crafted with love by 
            <a href="https://www.linkedin.com/in/mirko-caiani/" target="_blank" style="color: inherit; text-decoration: underline;">Mirko Caiani</a>
        </p>
    </footer>

    <script type="module">
        import { supabase } from './js/supabase-config.js';

        // --- FUNZIONI DI UTILITÀ ---

        // Attiva/Disattiva chip singolo (Toggle Multiplo - per Ruoli)
        function toggleMultiChip(element) {
            element.classList.toggle('selected');
        }

        // Attiva uno, spegni gli altri (Radio con Deselect - per BJCP/Cicerone/Homebrewer)
        // Se forceSelection è true, non permette di deselezionare l'ultimo rimasto (usato per Sì/No)
        function selectSingleChip(containerId, clickedElement, forceSelection = false) {
            const container = document.getElementById(containerId);
            const isAlreadySelected = clickedElement.classList.contains('selected');

            // Reset visivo di tutti
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));

            if (isAlreadySelected && !forceSelection) {
                // Se era selezionato e posso deselezionare: non faccio nulla (rimane spento)
                // Risultato: Nessuna selezione
            } else {
                // Se era spento OPPURE devo forzare selezione: lo accendo
                clickedElement.classList.add('selected');
            }
        }

        // Leggi valore Radio (ritorna stringa vuota se nulla selezionato)
        function getSingleValue(containerId) {
            const selected = document.getElementById(containerId).querySelector('.chip-btn.selected');
            return selected ? selected.getAttribute('data-value') : "";
        }

        // Imposta valore Radio (al caricamento)
        function setSingleValue(containerId, value) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
            if (value) {
                const target = container.querySelector(`.chip-btn[data-value="${value}"]`);
                if (target) target.classList.add('selected');
            }
        }

        // --- LOGICA VISIBILITÀ CONDIZIONALE ---

        // BJCP: ID visibile SOLO se selezionato QUALCOSA e DIVERSO da 'provisional'
        function checkBjcpVisibility() {
            const val = getSingleValue('bjcp-grid');
            const container = document.getElementById('bjcp-id-container');
            // Condizione: Valore esiste E non è provisional
            if (val && val !== "" && val !== "provisional") {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // CICERONE: Link visibile se c'è un livello
        function checkCiceroneVisibility() {
            const val = getSingleValue('cicerone-grid');
            const container = document.getElementById('cicerone-link-container');
            if (val && val !== "") {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // HOMEBREWER: Select visibile se 'yes'
        function checkHomebrewerVisibility() {
            const val = getSingleValue('hb-bool-grid');
            const container = document.getElementById('hb-club-container');
            if (val === 'yes') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // --- 1. CARICAMENTO DATI ---
        async function loadProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }

            const meta = user.user_metadata || {};
            
            // Info Base
            document.getElementById('user-email').value = user.email;
            document.getElementById('display-name').value = meta.full_name || "";
            
            // Avatar
            const nameForAvatar = meta.full_name || user.email;
            document.getElementById('avatar-initials').textContent = nameForAvatar.charAt(0).toUpperCase();

            // --- Homebrewer ---
            const isHb = meta.is_homebrewer === true ? 'yes' : 'no'; // Default No
            setSingleValue('hb-bool-grid', isHb);
            document.getElementById('hb-club-select').value = meta.homebrewer_club || 'solitario';
            checkHomebrewerVisibility();

            // Listener HB
            document.getElementById('hb-bool-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectSingleChip('hb-bool-grid', btn, true); // true = obbligatorio uno dei due
                    checkHomebrewerVisibility();
                });
            });

            // --- Ruoli (Multipli) ---
            const rolesGrid = document.getElementById('roles-grid');
            rolesGrid.querySelectorAll('.chip-btn').forEach(btn => {
                const roleKey = btn.getAttribute('data-role');
                if (meta[roleKey] === true) btn.classList.add('selected');
                btn.addEventListener('click', () => toggleMultiChip(btn));
            });

            // --- BJCP (Singolo Deselezionabile) ---
            setSingleValue('bjcp-grid', meta.bjcp_level || "");
            document.getElementById('bjcp-id').value = meta.bjcp_id || "";
            checkBjcpVisibility();

            document.getElementById('bjcp-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectSingleChip('bjcp-grid', btn); // false = posso deselezionare
                    checkBjcpVisibility();
                });
            });

            // --- Cicerone (Singolo Deselezionabile) ---
            setSingleValue('cicerone-grid', meta.cicerone_level || "");
            document.getElementById('cicerone-link').value = meta.cicerone_link || "";
            checkCiceroneVisibility();

            document.getElementById('cicerone-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectSingleChip('cicerone-grid', btn);
                    checkCiceroneVisibility();
                });
            });
        }
        loadProfile();

        // --- 2. SALVATAGGIO ---
        document.getElementById('save-profile').addEventListener('click', async () => {
            const btn = document.getElementById('save-profile');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined">sync</span> Salvataggio...`;
            btn.disabled = true;

            // Raccogli ruoli multipli
            const rolesUpdates = {};
            document.getElementById('roles-grid').querySelectorAll('.chip-btn').forEach(btn => {
                const key = btn.getAttribute('data-role');
                rolesUpdates[key] = btn.classList.contains('selected');
            });

            // Homebrewer Data
            const isHb = getSingleValue('hb-bool-grid') === 'yes';
            const club = isHb ? document.getElementById('hb-club-select').value : null;

            // BJCP Data
            const bjcpLevel = getSingleValue('bjcp-grid');
            // Se non c'è livello o è provisional, non salvo l'ID (o lo salvo vuoto)
            const bjcpId = (bjcpLevel && bjcpLevel !== 'provisional') ? document.getElementById('bjcp-id').value : "";

            // Cicerone Data
            const ciceroneLevel = getSingleValue('cicerone-grid');
            const ciceroneLink = ciceroneLevel ? document.getElementById('cicerone-link').value : "";

            const updates = {
                full_name: document.getElementById('display-name').value,
                
                // Ruoli
                ...rolesUpdates,

                // HB
                is_homebrewer: isHb,
                homebrewer_club: club,

                // BJCP
                bjcp_level: bjcpLevel,
                bjcp_id: bjcpId,

                // Cicerone
                cicerone_level: ciceroneLevel,
                cicerone_link: ciceroneLink
            };

            const { error } = await supabase.auth.updateUser({ data: updates });

            if (error) alert("Errore: " + error.message);
            else {
                alert("Profilo aggiornato! ✅");
                const newName = updates.full_name || document.getElementById('user-email').value;
                document.getElementById('avatar-initials').textContent = newName.charAt(0).toUpperCase();
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        });

        // --- 3. LOGOUT ---
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if(confirm("Vuoi davvero uscire?")) {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>