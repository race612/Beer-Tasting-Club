<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - Beer Tasting Club</title>
    <link rel="stylesheet" href="css/style.css?v=0.8.1">
    <link rel="manifest" href="/Beer-Tasting-Club/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <style>
        /* STILI SPECIFICI PROFILO */
        .profile-section-title {
            color: var(--primary-color);
            border-bottom: 1px solid #374151;
            padding-bottom: 5px;
            margin-top: 35px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .text-muted-small { color: var(--text-muted); font-size: 0.85em; font-weight: normal; margin-left: 5px; }

        /* LIVELLO ACCOUNT BADGE */
        .account-badge {
            background: #374151;
            color: #d1d5db;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            border: 1px solid #4b5563;
        }

        /* GRIGLIE PULSANTI (Chips) - Sempre 2 colonne */
        .chips-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .chip-btn {
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 12px 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            user-select: none;
            line-height: 1.2;
        }

        .chip-btn:hover { border-color: #9ca3af; background: #374151; }

        .chip-btn.selected {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.2);
        }

        /* Campi Nascosti (Stile pulito, identico ai form-group standard) */
        .hidden-field {
            display: none; /* Gestito da JS */
            margin-top: 15px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="header-bar">
            <a href="index.html" class="header-link">
                <span class="material-symbols-outlined">arrow_back</span> Home
            </a>
            <img src="assets/logo.png" alt="Logo" class="header-logo">
        </div>

        <div class="card">
            
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <div class="profile-avatar" id="avatar-initials" style="margin-bottom: 10px;">?</div>
                <div id="account-level-badge" class="account-badge">Degustatore</div>
                
                <div style="width: 100%; text-align: left;">
                    <div class="form-group">
                        <label>Nome Pubblico <span class="text-muted-small">(Nome e Cognome o Nickname)</span></label>
                        <input type="text" id="display-name" placeholder="Il tuo nome">
                    </div>
                    <div class="form-group">
                        <label>Email <span class="text-muted-small">(Non modificabile)</span></label>
                        <input type="email" id="user-email" disabled style="opacity: 0.6; cursor: not-allowed; color: #9ca3af;">
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label style="margin-bottom: 8px; display:block;">Sei un Homebrewer?</label>
                        <div class="chips-grid" id="hb-bool-grid">
                            <div class="chip-btn" data-value="yes">Sì</div>
                            <div class="chip-btn selected" data-value="no">No</div>
                        </div>
                    </div>

                    <div id="hb-club-container" class="hidden-field">
                        <label style="color: #d1d5db; font-size: 0.9rem; margin-bottom: 5px; display:block;">Associazione o Club:</label>
                        <select id="hb-club-select">
                            <option value="solitario">No, sono solitario</option>
                            <option value="passato">No, ma ne ho fatto parte in passato</option>
                            <option value="HBL">HBL - HomeBrewers Lombardi</option>
                            <option value="HBS">HBS - HomeBrewers Sardi</option>
                            <option value="AHBT">AHBT - Associazione HomeBrewers Ticino</option>
                            <option value="ABC">ABC - Associazione Birraria Cuneese</option>
                        </select>
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="margin-bottom: 8px; display:block;">Vuoi organizzare eventi e serate?</label>
                        <div class="chips-grid" id="org-bool-grid">
                            <div class="chip-btn" data-value="yes">Sì</div>
                            <div class="chip-btn selected" data-value="no">No</div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="profile-section-title">Livello BJCP</h3>
            <div class="chips-grid" id="bjcp-grid">
                <div class="chip-btn" data-value="provisional">Provisional Judge</div>
                <div class="chip-btn" data-value="pending">Rank Pending</div>
                <div class="chip-btn" data-value="apprentice">Apprentice Judge</div>
                <div class="chip-btn" data-value="recognized">Recognized Judge</div>
                <div class="chip-btn" data-value="certified">Certified Judge</div>
                <div class="chip-btn" data-value="national">National Judge</div>
                <div class="chip-btn" data-value="master">Master Judge</div>
                <div class="chip-btn" data-value="grand_master">Grand Master Judge</div>
            </div>

            <div id="bjcp-id-container" class="hidden-field">
                <label>Il tuo ID BJCP</label>
                <input type="text" id="bjcp-id" placeholder="Es. E1234">
            </div>

            <h3 class="profile-section-title">Livello Cicerone®</h3>
            <div class="chips-grid" id="cicerone-grid">
                <div class="chip-btn" data-value="server">Certified Beer Server</div>
                <div class="chip-btn" data-value="certified">Certified Cicerone</div>
                <div class="chip-btn" data-value="advanced">Advanced Cicerone</div>
                <div class="chip-btn" data-value="master">Master Cicerone</div>
            </div>

            <div id="cicerone-link-container" class="hidden-field">
                <label>Link al profilo Cicerone</label>
                <input type="url" id="cicerone-link" placeholder="https://www.cicerone.org/..." style="width: 100%;">
            </div>

            <h3 class="profile-section-title">Altre Qualifiche</h3>
            <div class="chips-grid" id="roles-grid">
                <div class="chip-btn" data-role="role_pro">Birraio</div>
                <div class="chip-btn" data-role="role_publican">Publican</div>
                <div class="chip-btn" data-role="role_ubt">Unionbirrai Beer Taster</div>
                <div class="chip-btn" data-role="role_doemens">Bier Sommelier Doemens</div>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label>Altri corsi di degustazione o Qualifiche</label>
                <textarea id="other-qualifications" rows="3" placeholder="Es. Sommelier AIS, Corsi di degustazione locali, ecc..."></textarea>
            </div>

            <button id="save-profile" class="btn btn-primary mt-20">
                <span class="material-symbols-outlined">save</span> Salva Profilo
            </button>
        </div>

        <button id="logout-btn" class="btn btn-danger-outline mt-20">
            <span class="material-symbols-outlined">logout</span> Esci dall'App
        </button>
    </div>

    <footer style="text-align: center; margin-top: 40px; font-size: 1rem; color: #4b5563;">
        &copy; 2026 Beer Tasting Club - 
        <a href="privacy.html" style="color: inherit; text-decoration: underline;">Info Privacy e Cookie</a>
        <p style="text-align: center; margin-top: 5px; font-size: 0.6rem; color: #4b5563;">
            Crafted with love by <a href="https://www.linkedin.com/in/mirko-caiani/" target="_blank" style="color: inherit; text-decoration: underline;">Mirko Caiani</a>
        </p>
    </footer>

    <script type="module">
        import { supabase } from './js/supabase-config.js';

        // --- HELPER FUNCTIONS ---
        function selectSingleChip(containerId, clickedElement, forceSelection = false) {
            const container = document.getElementById(containerId);
            const isSelected = clickedElement.classList.contains('selected');
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
            if (!isSelected || forceSelection) clickedElement.classList.add('selected');
        }

        function getSingleValue(containerId) {
            const el = document.getElementById(containerId).querySelector('.chip-btn.selected');
            return el ? el.getAttribute('data-value') : "";
        }

        function setSingleValue(containerId, value) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
            if (value) {
                const target = container.querySelector(`.chip-btn[data-value="${value}"]`);
                if (target) target.classList.add('selected');
            }
        }

        function toggleMultiChip(el) { el.classList.toggle('selected'); }

        // --- VISIBILITY CHECKS ---
        function checkBjcpVisibility() {
            const val = getSingleValue('bjcp-grid');
            const el = document.getElementById('bjcp-id-container');
            // Mostra se diverso da vuoto e diverso da provisional e pending (opzionale, ma tu hai chiesto da Provisional in su non mostrare?)
            // Rileggendo: "in caso non ci sia nulla ... oppure sia provisional non mostrare"
            // Quindi mostriamo solo se non è provisional e non è pending (assumo pending sia minore)
            if (val && val !== "" && val !== "provisional" && val !== "pending") el.style.display = 'block';
            else el.style.display = 'none';
        }

        function checkCiceroneVisibility() {
            const val = getSingleValue('cicerone-grid');
            const el = document.getElementById('cicerone-link-container');
            if (val && val !== "") el.style.display = 'block'; else el.style.display = 'none';
        }

        function checkHbVisibility() {
            const val = getSingleValue('hb-bool-grid');
            const el = document.getElementById('hb-club-container');
            if (val === 'yes') el.style.display = 'block'; else el.style.display = 'none';
        }

        // --- 1. LOAD DATA ---
        async function loadProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }
            const meta = user.user_metadata || {};

            // Header
            document.getElementById('user-email').value = user.email;
            document.getElementById('display-name').value = meta.full_name || "";
            const name = meta.full_name || user.email;
            document.getElementById('avatar-initials').textContent = name.charAt(0).toUpperCase();
            
            // Badge Livello (Load da DB o calcolo al volo, meglio mostrarlo subito)
            document.getElementById('account-level-badge').textContent = meta.account_level || "Degustatore";

            // Homebrewer
            const isHb = meta.is_homebrewer === true ? 'yes' : 'no';
            setSingleValue('hb-bool-grid', isHb);
            document.getElementById('hb-club-select').value = meta.homebrewer_club || 'solitario';
            checkHbVisibility();

            // Organizer
            const isOrg = meta.is_organizer === true ? 'yes' : 'no';
            setSingleValue('org-bool-grid', isOrg);

            // BJCP
            setSingleValue('bjcp-grid', meta.bjcp_level || "");
            document.getElementById('bjcp-id').value = meta.bjcp_id || "";
            checkBjcpVisibility();

            // Cicerone
            setSingleValue('cicerone-grid', meta.cicerone_level || "");
            document.getElementById('cicerone-link').value = meta.cicerone_link || "";
            checkCiceroneVisibility();

            // Altre Qualifiche (4 fisse)
            const rolesGrid = document.getElementById('roles-grid');
            rolesGrid.querySelectorAll('.chip-btn').forEach(btn => {
                const k = btn.getAttribute('data-role');
                if (meta[k] === true) btn.classList.add('selected');
                btn.addEventListener('click', () => toggleMultiChip(btn));
            });

            // Campo Testo Libero
            document.getElementById('other-qualifications').value = meta.other_qualifications || "";

            // Listeners
            document.getElementById('hb-bool-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => { selectSingleChip('hb-bool-grid', btn, true); checkHbVisibility(); });
            });
            document.getElementById('org-bool-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => selectSingleChip('org-bool-grid', btn, true));
            });
            document.getElementById('bjcp-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => { selectSingleChip('bjcp-grid', btn); checkBjcpVisibility(); });
            });
            document.getElementById('cicerone-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => { selectSingleChip('cicerone-grid', btn); checkCiceroneVisibility(); });
            });
        }
        loadProfile();

        // --- 2. SAVE & CALCULATE LEVEL ---
        document.getElementById('save-profile').addEventListener('click', async () => {
            const btn = document.getElementById('save-profile');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined">sync</span> Salvataggio...`;
            btn.disabled = true;

            // Raccogli Dati
            const isHb = getSingleValue('hb-bool-grid') === 'yes';
            const isOrg = getSingleValue('org-bool-grid') === 'yes';
            const isBirraio = document.querySelector('.chip-btn[data-role="role_pro"]').classList.contains('selected');

            // CALCOLO LIVELLO ACCOUNT
            // Logica: Event Master (se org) > Produttore (se hb o birraio) > Degustatore (default)
            let newLevel = "Degustatore";
            if (isHb || isBirraio) newLevel = "Produttore";
            if (isOrg) newLevel = "Event Master";

            const rolesUpdates = {};
            document.getElementById('roles-grid').querySelectorAll('.chip-btn').forEach(btn => {
                rolesUpdates[btn.getAttribute('data-role')] = btn.classList.contains('selected');
            });

            const bjcpLevel = getSingleValue('bjcp-grid');
            const updates = {
                full_name: document.getElementById('display-name').value,
                account_level: newLevel,
                is_homebrewer: isHb,
                homebrewer_club: isHb ? document.getElementById('hb-club-select').value : null,
                is_organizer: isOrg,
                bjcp_level: bjcpLevel,
                bjcp_id: (bjcpLevel && bjcpLevel !== 'provisional' && bjcpLevel !== 'pending') ? document.getElementById('bjcp-id').value : "",
                cicerone_level: getSingleValue('cicerone-grid'),
                cicerone_link: getSingleValue('cicerone-grid') ? document.getElementById('cicerone-link').value : "",
                ...rolesUpdates,
                other_qualifications: document.getElementById('other-qualifications').value
            };

            const { error } = await supabase.auth.updateUser({ data: updates });

            if (error) {
                alert("Errore: " + error.message);
            } else {
                alert("Profilo aggiornato! ✅");
                // Aggiorna UI subito
                const newName = updates.full_name || document.getElementById('user-email').value;
                document.getElementById('avatar-initials').textContent = newName.charAt(0).toUpperCase();
                document.getElementById('account-level-badge').textContent = newLevel;
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        });

        // --- 3. LOGOUT ---
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if(confirm("Vuoi davvero uscire?")) {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>