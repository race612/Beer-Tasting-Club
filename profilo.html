<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - Beer Tasting Club</title>
    <link rel="stylesheet" href="css/style.css?v=0.8.1">
    <link rel="manifest" href="/Beer-Tasting-Club/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
</head>
<body>
    <div class="container">
        
        <div class="header-bar">
            <a href="index.html" class="header-link">
                <span class="material-symbols-outlined">arrow_back</span> Home
            </a>
            <img src="assets/logo.png" alt="Logo" class="header-logo">
        </div>

        <div class="card">
            
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <div class="profile-avatar" id="avatar-initials" style="margin-bottom: 10px;">?</div>
                
                <div class="account-badge">
                    Level: <span id="account-level-val" style="font-weight: bold; color: white;">Taster</span>
                </div>
                
                <div style="width: 100%; text-align: left;">
                    <div class="form-group">
                        <label>Nome Pubblico <span class="text-muted-small">(Nome e Cognome o Nickname)</span></label>
                        <input type="text" id="display-name" placeholder="Il tuo nome">
                    </div>
                    <div class="form-group">
                        <label>Email <span class="text-muted-small">(Non modificabile)</span></label>
                        <input type="email" id="user-email" disabled style="opacity: 0.6; cursor: not-allowed; color: #9ca3af;">
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label style="margin-bottom: 8px; display:block;">Sei un Homebrewer?</label>
                        <div class="chips-grid" id="hb-bool-grid">
                            <div class="chip-btn" data-value="yes">Sì</div>
                            <div class="chip-btn selected" data-value="no">No</div>
                        </div>
                    </div>

                    <div id="hb-club-container" class="hidden-field">
                        <label style="margin-bottom: 5px; display:block;">Associazione o Club:</label>
                        <select id="hb-club-select">
                            <option value="solitario">No, sono solitario</option>
                            <option value="passato">No, ma ne ho fatto parte in passato</option>
                            <option value="HBL">HBL - HomeBrewers Lombardi</option>
                            <option value="HBS">HBS - HomeBrewers Sardi</option>
                            <option value="AHBT">AHBT - Associazione HomeBrewers Ticino</option>
                            <option value="ABC">ABC - Associazione Birraria Cuneese</option>
                            <option value="HBF">HBF - Homebrewers Fiorentini</option>
                            <option value="HBN">HBN - Homebrewers Novaresi</option>
                            <option value="Trinacria">Trinacria Homebrewers</option>
                        </select>
                    </div>

                    <div style="margin-top: 20px;">
                        <label style="margin-bottom: 8px; display:block;">Vuoi organizzare eventi e serate?</label>
                        <div class="chips-grid" id="org-bool-grid">
                            <div class="chip-btn" data-value="yes">Sì</div>
                            <div class="chip-btn selected" data-value="no">No</div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="profile-section-title">Livello BJCP</h3>
            <div class="chips-grid" id="bjcp-grid">
                <div class="chip-btn" data-value="provisional">Provisional Judge</div>
                <div class="chip-btn" data-value="pending">Rank Pending</div>
                <div class="chip-btn" data-value="apprentice">Apprentice Judge</div>
                <div class="chip-btn" data-value="recognized">Recognized Judge</div>
                <div class="chip-btn" data-value="certified">Certified Judge</div>
                <div class="chip-btn" data-value="national">National Judge</div>
                <div class="chip-btn" data-value="master">Master Judge</div>
                <div class="chip-btn" data-value="grand_master">Grand Master Judge</div>
            </div>

            <div id="bjcp-id-container" class="hidden-field form-group">
                <label>Il tuo ID BJCP</label>
                <input type="text" id="bjcp-id" placeholder="Es. E1234">
            </div>

            <h3 class="profile-section-title">Livello Cicerone®</h3>
            <div class="chips-grid" id="cicerone-grid">
                <div class="chip-btn" data-value="server">Certified Beer Server</div>
                <div class="chip-btn" data-value="certified">Certified Cicerone</div>
                <div class="chip-btn" data-value="advanced">Advanced Cicerone</div>
                <div class="chip-btn" data-value="master">Master Cicerone</div>
            </div>

            <div id="cicerone-link-container" class="hidden-field form-group">
                <label>Link al profilo Cicerone</label>
                <input type="text" id="cicerone-link" placeholder="https://www.cicerone.org/..." style="width: 100%;">
            </div>

            <h3 class="profile-section-title">Altre Qualifiche</h3>
            <div class="chips-grid" id="roles-grid">
                <div class="chip-btn" data-role="role_pro">Birraio</div>
                <div class="chip-btn" data-role="role_publican">Publican</div>
                <div class="chip-btn" data-role="role_ubt">Unionbirrai Beer Taster</div>
                <div class="chip-btn" data-role="role_doemens">Bier Sommelier Doemens</div>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label>Altri corsi di degustazione o Qualifiche</label>
                <textarea id="other-qualifications" rows="3" placeholder="Es. Sommelier AIS, Corsi di degustazione locali, ecc..."></textarea>
            </div>

            <h3 class="profile-section-title">Contatti e Social</h3>
            <div class="form-group">
                <label>Numero WhatsApp</label>
                <input type="text" id="social-whatsapp" placeholder="+39 333...">
            </div>
            <div class="form-group">
                <label>Username Telegram</label>
                <input type="text" id="social-telegram" placeholder="@username">
            </div>
            <div class="form-group">
                <label>Link Facebook</label>
                <input type="text" id="social-facebook" placeholder="https://facebook.com/...">
            </div>
            <div class="form-group">
                <label>Link Instagram</label>
                <input type="text" id="social-instagram" placeholder="@username o Link">
            </div>
            <div class="form-group">
                <label>Link LinkedIn</label>
                <input type="text" id="social-linkedin" placeholder="https://linkedin.com/in/...">
            </div>

            <h3 class="profile-section-title">Privacy</h3>
            <div class="form-group">
                <label>Scegli che dati condividere quando esporti o salvi una scheda</label>
                <select id="privacy-share">
                    <option value="name_only">Solo nome pubblico o nickname</option>
                    <option value="name_contact">Nome, Mail e info di contatto/Social</option>
                    <option value="name_bjcp">Nome, Mail e Livello BJCP</option>
                    <option value="full">Profilo Completo - Tutte le info inserite saranno condivise</option>
                </select>
            </div>

            <button id="save-profile" class="btn btn-primary mt-20">
                <span class="material-symbols-outlined">save</span> Salva Profilo
            </button>
        </div>

        <button id="logout-btn" class="btn btn-danger-outline mt-20">
            <span class="material-symbols-outlined">logout</span> Esci dall'App
        </button>
    </div>

    <footer style="text-align: center; margin-top: 40px; font-size: 1rem; color: #4b5563;">
        &copy; 2026 Beer Tasting Club <span class="footer-ver" id="footer-version">v...</span><br>
        <a href="privacy.html" style="color: inherit; text-decoration: underline;">Info Privacy e Cookie</a>
        <p style="text-align: center; margin-top: 5px; font-size: 0.7rem; color: #4b5563; display: flex; align-items: center; justify-content: center; gap: 4px;">
            Crafted with love by <a href="https://www.linkedin.com/in/mirko-caiani/" target="_blank" style="color: inherit; text-decoration: underline;">Mirko Caiani</a>
        </p>
    </footer>

    <div id="update-toast" class="update-toast">
        <span class="material-symbols-outlined">system_update</span>
        Nuova versione! Clicca qui.
    </div>

    <script type="module">
        // 1. IMPORT (TASSATIVAMENTE IN CIMA)
        import { supabase } from './js/supabase-config.js';
        import { APP_VERSION } from './js/config.js'; // Usa ./ perché siamo in root
        import { showModal } from './js/modal.js';

        // 2. VERSION & UPDATE LOGIC (Robust)
        const footerVer = document.getElementById('footer-version');
        if (footerVer) footerVer.textContent = ` v${APP_VERSION}`;

        const updateToast = document.getElementById('update-toast');

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                
                // A) Aggiornamento GIA' in attesa
                if (reg.waiting) {
                    if(updateToast) updateToast.classList.add('show');
                }

                // B) Aggiornamento trovato ORA
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if(updateToast) updateToast.classList.add('show');
                        }
                    });
                });
            }).catch(err => console.log('SW failed', err));
        }

        // Click -> Aggiorna
        if(updateToast) {
            updateToast.addEventListener('click', () => {
                if (navigator.serviceWorker.controller) {
                    window.location.reload();
                }
            });
        }

        // --- HELPER FUNCTIONS ---
        function selectSingleChip(containerId, clickedElement, forceSelection = false) {
            const container = document.getElementById(containerId);
            const isSelected = clickedElement.classList.contains('selected');
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
            if (!isSelected || forceSelection) clickedElement.classList.add('selected');
        }

        function getSingleValue(containerId) {
            const el = document.getElementById(containerId).querySelector('.chip-btn.selected');
            return el ? el.getAttribute('data-value') : "";
        }

        function setSingleValue(containerId, value) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
            if (value) {
                const target = container.querySelector(`.chip-btn[data-value="${value}"]`);
                if (target) target.classList.add('selected');
            }
        }

        function toggleMultiChip(el) { el.classList.toggle('selected'); }

        // --- VISIBILITY CHECKS ---
        function checkBjcpVisibility() {
            const val = getSingleValue('bjcp-grid');
            const el = document.getElementById('bjcp-id-container');
            if (val && val !== "" && val !== "provisional") el.style.display = 'block';
            else el.style.display = 'none';
        }

        function checkCiceroneVisibility() {
            const val = getSingleValue('cicerone-grid');
            const el = document.getElementById('cicerone-link-container');
            if (val && val !== "") el.style.display = 'block'; else el.style.display = 'none';
        }

        function checkHbVisibility() {
            const val = getSingleValue('hb-bool-grid');
            const el = document.getElementById('hb-club-container');
            if (val === 'yes') el.style.display = 'block'; else el.style.display = 'none';
        }

        // --- 3. LOAD DATA ---
        async function loadProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }
            const meta = user.user_metadata || {};

            // Header
            document.getElementById('user-email').value = user.email;
            document.getElementById('display-name').value = meta.full_name || "";
            const name = meta.full_name || user.email;
            document.getElementById('avatar-initials').textContent = name.charAt(0).toUpperCase();
            document.getElementById('account-level-val').textContent = meta.account_level || "Taster";

            // Homebrewer
            const isHb = meta.is_homebrewer === true ? 'yes' : 'no';
            setSingleValue('hb-bool-grid', isHb);
            document.getElementById('hb-club-select').value = meta.homebrewer_club || 'solitario';
            checkHbVisibility();

            // Organizer
            const isOrg = meta.is_organizer === true ? 'yes' : 'no';
            setSingleValue('org-bool-grid', isOrg);

            // BJCP
            setSingleValue('bjcp-grid', meta.bjcp_level || "");
            document.getElementById('bjcp-id').value = meta.bjcp_id || "";
            checkBjcpVisibility();

            // Cicerone
            setSingleValue('cicerone-grid', meta.cicerone_level || "");
            document.getElementById('cicerone-link').value = meta.cicerone_link || "";
            checkCiceroneVisibility();

            // Altre Qualifiche
            const rolesGrid = document.getElementById('roles-grid');
            rolesGrid.querySelectorAll('.chip-btn').forEach(btn => {
                const k = btn.getAttribute('data-role');
                if (meta[k] === true) btn.classList.add('selected');
                btn.addEventListener('click', () => toggleMultiChip(btn));
            });

            // Campo Testo Libero
            document.getElementById('other-qualifications').value = meta.other_qualifications || "";

            // Socials
            document.getElementById('social-whatsapp').value = meta.social_whatsapp || "";
            document.getElementById('social-telegram').value = meta.social_telegram || "";
            document.getElementById('social-facebook').value = meta.social_facebook || "";
            document.getElementById('social-instagram').value = meta.social_instagram || "";
            document.getElementById('social-linkedin').value = meta.social_linkedin || "";

            // Privacy
            document.getElementById('privacy-share').value = meta.privacy_share_level || "name_only";

            // Listeners
            document.getElementById('hb-bool-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => { selectSingleChip('hb-bool-grid', btn, true); checkHbVisibility(); });
            });
            document.getElementById('org-bool-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => selectSingleChip('org-bool-grid', btn, true));
            });
            document.getElementById('bjcp-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => { selectSingleChip('bjcp-grid', btn); checkBjcpVisibility(); });
            });
            document.getElementById('cicerone-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => { selectSingleChip('cicerone-grid', btn); checkCiceroneVisibility(); });
            });
        }
        loadProfile();

        // --- 4. SAVE ---
        document.getElementById('save-profile').addEventListener('click', async () => {
            const btn = document.getElementById('save-profile');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined">sync</span> Salvataggio...`;
            btn.disabled = true;

            const isHb = getSingleValue('hb-bool-grid') === 'yes';
            const isOrg = getSingleValue('org-bool-grid') === 'yes';
            const isBirraio = document.querySelector('.chip-btn[data-role="role_pro"]').classList.contains('selected');

            let newLevel = "Taster";
            if (isHb || isBirraio) newLevel = "Brewer";
            if (isOrg) newLevel = "Event Master";

            const rolesUpdates = {};
            document.getElementById('roles-grid').querySelectorAll('.chip-btn').forEach(btn => {
                rolesUpdates[btn.getAttribute('data-role')] = btn.classList.contains('selected');
            });

            const bjcpLevel = getSingleValue('bjcp-grid');
            
            const updates = {
                full_name: document.getElementById('display-name').value,
                account_level: newLevel,
                is_homebrewer: isHb,
                homebrewer_club: isHb ? document.getElementById('hb-club-select').value : null,
                is_organizer: isOrg,
                
                bjcp_level: bjcpLevel,
                bjcp_id: (bjcpLevel && bjcpLevel !== 'provisional') ? document.getElementById('bjcp-id').value : "",
                
                cicerone_level: getSingleValue('cicerone-grid'),
                cicerone_link: getSingleValue('cicerone-grid') ? document.getElementById('cicerone-link').value : "",
                
                ...rolesUpdates,
                other_qualifications: document.getElementById('other-qualifications').value,

                social_whatsapp: document.getElementById('social-whatsapp').value,
                social_telegram: document.getElementById('social-telegram').value,
                social_facebook: document.getElementById('social-facebook').value,
                social_instagram: document.getElementById('social-instagram').value,
                social_linkedin: document.getElementById('social-linkedin').value,

                privacy_share_level: document.getElementById('privacy-share').value
            };

            const { error } = await supabase.auth.updateUser({ data: updates });

            if (error) {
                await showModal("Errore", "Errore: " + error.message, "error");
            } else {
                await showModal("Profilo Aggiornato", "I dati sono stati salvati correttamente.", "success");
                const newName = updates.full_name || document.getElementById('user-email').value;
                document.getElementById('avatar-initials').textContent = newName.charAt(0).toUpperCase();
                document.getElementById('account-level-val').textContent = newLevel;
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        });

        // --- 5. LOGOUT ---
        document.getElementById('logout-btn').addEventListener('click', async () => {
            const proceed = await showModal("Logout", "Vuoi davvero uscire?", "confirm", "logout");
            if(proceed) {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>