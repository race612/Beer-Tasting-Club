<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilo - Beer Tasting Club</title>
    <link rel="stylesheet" href="css/style.css?v=0.8.1">
    <link rel="manifest" href="/Beer-Tasting-Club/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <style>
        /* STILI SPECIFICI PER PROFILO (Chips & Grids) */
        .profile-section-title {
            color: var(--primary-color);
            border-bottom: 1px solid #374151;
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Griglia Pulsanti (Simile a scheda degustazione) */
        .chips-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .chip-btn {
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 12px 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            user-select: none;
        }

        .chip-btn:hover {
            border-color: #9ca3af;
            background: #374151;
        }

        .chip-btn.selected {
            background: rgba(245, 158, 11, 0.15); /* Ambra trasparente */
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.2);
        }

        /* Badge ID BJCP (Condizionale) */
        #bjcp-id-container {
            margin-top: 15px;
            background: #374151;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            animation: fadeIn 0.3s ease-out;
            display: none; /* Nascosto di default */
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        
        <div class="header-bar">
            <a href="index.html" class="header-link">
                <span class="material-symbols-outlined">arrow_back</span> Home
            </a>
            <img src="assets/logo.png" alt="Logo" class="header-logo">
        </div>

        <div class="card">
            
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <div class="profile-avatar" id="avatar-initials" style="margin-bottom: 15px;">?</div>
                
                <div style="width: 100%; text-align: left;">
                    <div class="form-group">
                        <label>Nome Pubblico</label>
                        <input type="text" id="display-name" placeholder="Il tuo nome">
                    </div>
                    <div class="form-group">
                        <label>Email (Non modificabile)</label>
                        <input type="email" id="user-email" disabled style="opacity: 0.6; cursor: not-allowed;">
                    </div>
                </div>
            </div>

            <h3 class="profile-section-title">Qualifiche & Ruoli</h3>
            <div class="chips-grid" id="roles-grid">
                <div class="chip-btn" data-role="role_pro">Birraio Pro</div>
                <div class="chip-btn" data-role="role_publican">Publican</div>
                <div class="chip-btn" data-role="role_ubt">Giudice UBT</div>
                <div class="chip-btn" data-role="role_doemens">Doemens</div>
                <div class="chip-btn" data-role="role_sommelier">Beer Sommelier</div>
                <div class="chip-btn" data-role="role_courses">Degustatore</div>
            </div>

            <h3 class="profile-section-title">Livello BJCP</h3>
            <div class="chips-grid" id="bjcp-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="chip-btn" data-value="">Nessuno</div>
                <div class="chip-btn" data-value="provisional">Provisional</div>
                <div class="chip-btn" data-value="recognized">Recognized</div>
                <div class="chip-btn" data-value="certified">Certified</div>
                <div class="chip-btn" data-value="national">National</div>
                <div class="chip-btn" data-value="master">Master</div>
            </div>

            <div id="bjcp-id-container">
                <label style="color: #d1d5db; font-size: 0.9rem;">Il tuo ID BJCP</label>
                <input type="text" id="bjcp-id" placeholder="Es. E1234" style="margin-top: 5px;">
            </div>

            <h3 class="profile-section-title">Livello Cicerone®</h3>
            <div class="chips-grid" id="cicerone-grid"> <div class="chip-btn" data-value="" style="grid-column: span 2;">Nessuno / Non specificato</div>
                <div class="chip-btn" data-value="server">Cert. Beer Server</div>
                <div class="chip-btn" data-value="certified">Certified Cicerone</div>
                <div class="chip-btn" data-value="advanced">Advanced Cicerone</div>
                <div class="chip-btn" data-value="master">Master Cicerone</div>
            </div>

            <button id="save-profile" class="btn btn-primary mt-20">
                <span class="material-symbols-outlined">save</span> Salva Profilo
            </button>
        </div>

        <button id="logout-btn" class="btn btn-danger-outline mt-20">
            <span class="material-symbols-outlined">logout</span> Esci dall'App
        </button>
    </div>

    <footer style="text-align: center; margin-top: 40px; font-size: 1rem; color: #4b5563;">
        &copy; 2026 Beer Tasting Club - 
        <a href="privacy.html" style="color: inherit; text-decoration: underline;">Info Privacy e Cookie</a>
        
        <p style="text-align: center; margin-top: 5px; font-size: 0.6rem; color: #4b5563;">
            Crafted with love by 
            <a href="https://www.linkedin.com/in/mirko-caiani/" target="_blank" style="color: inherit; text-decoration: underline;">Mirko Caiani</a>
        </p>
    </footer>

    <script type="module">
        import { supabase } from './js/supabase-config.js';

        let currentUserMeta = {};

        // --- FUNZIONI DI UTILITÀ PER CHIPS ---
        
        // Attiva/Disattiva chip singolo (Toggle Multiplo)
        function toggleChip(element) {
            element.classList.toggle('selected');
        }

        // Attiva uno, spegni gli altri (Radio Singolo)
        function selectSingleChip(containerId, selectedElement) {
            const container = document.getElementById(containerId);
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
            selectedElement.classList.add('selected');
        }

        // Leggi valore Radio
        function getSingleValue(containerId) {
            const selected = document.getElementById(containerId).querySelector('.chip-btn.selected');
            return selected ? selected.getAttribute('data-value') : "";
        }

        // Imposta valore Radio (al caricamento)
        function setSingleValue(containerId, value) {
            const container = document.getElementById(containerId);
            // Reset
            container.querySelectorAll('.chip-btn').forEach(btn => btn.classList.remove('selected'));
            // Trova e attiva
            const target = container.querySelector(`.chip-btn[data-value="${value}"]`) || container.querySelector(`.chip-btn[data-value=""]`);
            if (target) target.classList.add('selected');
        }

        // --- LOGICA BJCP VISIBILITY ---
        function checkBjcpVisibility() {
            const val = getSingleValue('bjcp-grid');
            const container = document.getElementById('bjcp-id-container');
            if (val && val !== "") {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                document.getElementById('bjcp-id').value = ""; // Pulisci se nascondi
            }
        }

        // --- 1. CARICAMENTO DATI ---
        async function loadProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }

            const meta = user.user_metadata || {};
            currentUserMeta = meta; // Cache
            
            // Info Base
            document.getElementById('user-email').value = user.email;
            document.getElementById('display-name').value = meta.full_name || "";
            
            // Avatar
            const nameForAvatar = meta.full_name || user.email;
            document.getElementById('avatar-initials').textContent = nameForAvatar.charAt(0).toUpperCase();

            // Ruoli (Multipli)
            const rolesGrid = document.getElementById('roles-grid');
            rolesGrid.querySelectorAll('.chip-btn').forEach(btn => {
                const roleKey = btn.getAttribute('data-role');
                if (meta[roleKey] === true) btn.classList.add('selected');
                
                // Click Listener
                btn.addEventListener('click', () => toggleChip(btn));
            });

            // BJCP (Singolo)
            setSingleValue('bjcp-grid', meta.bjcp_level || "");
            document.getElementById('bjcp-id').value = meta.bjcp_id || "";
            checkBjcpVisibility(); // Controlla subito se mostrare ID

            // Click Listener BJCP
            document.getElementById('bjcp-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectSingleChip('bjcp-grid', btn);
                    checkBjcpVisibility(); // Controlla al click
                });
            });

            // Cicerone (Singolo)
            setSingleValue('cicerone-grid', meta.cicerone_level || "");
            
            // Click Listener Cicerone
            document.getElementById('cicerone-grid').querySelectorAll('.chip-btn').forEach(btn => {
                btn.addEventListener('click', () => selectSingleChip('cicerone-grid', btn));
            });
        }
        loadProfile();

        // --- 2. SALVATAGGIO ---
        document.getElementById('save-profile').addEventListener('click', async () => {
            const btn = document.getElementById('save-profile');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined">sync</span> Salvataggio...`;
            btn.disabled = true;

            // Raccogli ruoli
            const rolesUpdates = {};
            document.getElementById('roles-grid').querySelectorAll('.chip-btn').forEach(btn => {
                const key = btn.getAttribute('data-role');
                rolesUpdates[key] = btn.classList.contains('selected');
            });

            const updates = {
                full_name: document.getElementById('display-name').value,
                ...rolesUpdates, // Spread dei ruoli
                bjcp_level: getSingleValue('bjcp-grid'),
                bjcp_id: document.getElementById('bjcp-id').value,
                cicerone_level: getSingleValue('cicerone-grid')
            };

            const { error } = await supabase.auth.updateUser({ data: updates });

            if (error) alert("Errore: " + error.message);
            else {
                alert("Profilo aggiornato! ✅");
                const newName = updates.full_name || document.getElementById('user-email').value;
                document.getElementById('avatar-initials').textContent = newName.charAt(0).toUpperCase();
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        });

        // --- 3. LOGOUT ---
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if(confirm("Vuoi davvero uscire?")) {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>