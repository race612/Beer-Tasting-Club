<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Scheda - Beer Tasting Club</title>
    
    <link rel="stylesheet" href="css/style.css?v=0.8.1">
    
    <link rel="manifest" href="/Beer-Tasting-Club/manifest.json">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="module" src="js/app.js"></script>
</head>
<body>
    <div class="container" style="max-width: 100%;">
        
        <div class="controls" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px;">
            <a href="storico.html" class="btn btn-secondary" style="width: auto;">
                <span class="material-symbols-outlined">arrow_back</span> Indietro
            </a>
    
            <button id="btn-delete" class="btn btn-outline" style="width: auto; border-color: #ef4444; color: #ef4444;">
                <span class="material-symbols-outlined">delete</span> Elimina
            </button>
    
            <button id="btn-download" class="btn btn-primary" style="width: auto;">
                <span class="material-symbols-outlined">download</span> Scarica PDF
            </button>
        </div>

        <div id="loading" style="text-align: center;">Caricamento scheda...</div>

        <div id="print-area" class="paper-sheet" style="display: none;">
            
            <div class="pdf-header">
                <div>
                    <h2 style="margin: 0; color: #000;">Scheda di Degustazione</h2>
                    <div style="font-size: 0.9rem; margin-top: 5px;">Beer Tasting Club</div>
                </div>
                <img src="assets/logo.png" class="pdf-logo" alt="Beer Tasting Club">
            </div>

            <div style="margin-bottom: 20px; font-family: sans-serif;">
                <div id="row-event" style="display: flex; margin-bottom: 5px;">
                    <strong style="width: 120px;">Evento:</strong>
                    <span id="pdf-event">...</span>
                </div>
                <div style="display: flex; margin-bottom: 5px;">
                    <strong style="width: 120px;">Data:</strong>
                    <span id="pdf-date">...</span>
                </div>
                <div style="display: flex; margin-bottom: 5px;">
                    <strong style="width: 120px;">Birra / ID:</strong>
                    <span id="pdf-beer" style="font-weight: bold; font-size: 1.1em;">...</span>
                </div>
                <div style="display: flex; margin-bottom: 5px;">
                    <strong style="width: 120px;">Stile:</strong>
                    <span id="pdf-style">...</span>
                </div>
            </div>

            <h3 style="margin: 0 0 10px 0; color: #000; border-bottom: 1px solid #000; font-family: sans-serif;">Valutazione</h3>
            <div class="score-grid" id="pdf-scores"></div>

            <h3 style="margin: 20px 0 10px 0; color: #000; border-bottom: 1px solid #000; font-family: sans-serif;">Note di Degustazione</h3>
            <div id="pdf-notes" style="white-space: pre-wrap; min-height: 100px; border: 1px solid #eee; padding: 10px;"></div>

            <div class="judge-box">
                <div style="font-weight: bold; margin-bottom: 5px;">Giudice:</div>
                <div id="judge-name" style="font-size: 1.1em;">...</div>
                <div id="judge-rank" style="font-size: 0.9em; color: #555; margin-top: 2px;"></div>
                <div id="judge-id" style="font-size: 0.9em; color: #555;"></div>
                <div id="judge-email" style="font-size: 0.8em; color: #777; margin-top: 5px;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px; font-size: 0.8rem; color: #999;">
                Scheda generata digitalmente tramite Beer Tasting Club App
            </div>
        </div>
    </div>
    <footer style="text-align: center; margin-top: 40px; font-size: 1rem; color: #4b5563;">
            &copy; 2026 Beer Tasting Club - 
            <a href="privacy.html" style="color: inherit; text-decoration: underline;">Info Privacy e Cookie</a>
            
            <p style="text-align: center; margin-top: 5px; font-size: 0.6rem; color: #4b5563;">
                Crafted with love by 
                <a href="https://www.linkedin.com/in/mirko-caiani/" target="_blank" style="color: inherit; text-decoration: underline;">Mirko Caiani</a>
            </p>
        </footer>
    <script type="module">
        import { supabase } from './js/supabase-config.js';

        const params = new URLSearchParams(window.location.search);
        const noteId = params.get('id');

        const ciceroneMap = {
            'server': 'Certified Beer Server',
            'certified': 'Certified Cicerone',
            'advanced': 'Advanced Cicerone',
            'master': 'Master Cicerone'
        };

        if (!noteId) {
            window.location.href = 'storico.html';
        }

        async function loadSheet() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { window.location.href = 'index.html'; return; }

            const { data: note, error } = await supabase
                .from('tasting_notes')
                .select('*, events(name)')
                .eq('id', noteId)
                .single();

            if (error) { alert("Errore: " + error.message); return; }

            // GESTIONE EVENTO
            const evtName = note.events ? note.events.name : "";
            if (evtName.toLowerCase().includes('libero') || evtName.toLowerCase().includes('privato')) {
                document.getElementById('row-event').classList.add('hidden-row');
            } else {
                document.getElementById('pdf-event').textContent = evtName;
            }

            document.getElementById('pdf-date').textContent = new Date(note.created_at).toLocaleDateString('it-IT');
            document.getElementById('pdf-beer').textContent = note.beer_name;
            document.getElementById('pdf-style').textContent = note.details.style || "-";
            document.getElementById('pdf-notes').textContent = note.details.notes || "Nessuna nota inserita.";

            if (note.sheet_type === 'bjcp_sintetica' && note.details.scores) {
                const s = note.details.scores;
                const htmlScores = `
                    <div class="score-item"><span>Aroma</span> <strong>${s.aroma}/12</strong></div>
                    <div class="score-item"><span>Aspetto</span> <strong>${s.appearance}/3</strong></div>
                    <div class="score-item"><span>Gusto</span> <strong>${s.flavor}/20</strong></div>
                    <div class="score-item"><span>Corpo</span> <strong>${s.mouthfeel}/5</strong></div>
                    <div class="score-item"><span>Generale</span> <strong>${s.overall}/10</strong></div>
                    <div class="score-item" style="grid-column: span 2;"></div>
                    <div class="score-total" style="grid-column: span 2;">TOTALE: ${note.final_score}/50</div>
                `;
                document.getElementById('pdf-scores').innerHTML = htmlScores;
            } else {
                document.getElementById('pdf-scores').innerHTML = "<div>Dettagli punteggio non supportati.</div>";
            }

            // INFO GIUDICE
            const meta = user.user_metadata;
            const fullName = `${meta.first_name || ""} ${meta.last_name || ""}`;
            
            let ranks = [];
            if (meta.bjcp_level) ranks.push(`BJCP ${meta.bjcp_level.replace('_', ' ')}`);
            if (meta.cicerone_level) ranks.push(ciceroneMap[meta.cicerone_level] || meta.cicerone_level);
            if (meta.role_pro) ranks.push("Birraio Professionista");
            if (meta.role_publican) ranks.push("Publican");
            if (meta.role_ubt) ranks.push("Giudice UBT");
            if (meta.role_doemens) ranks.push("Biersommelier Doemens");
            if (meta.role_sommelier) ranks.push("Beer Sommelier");
            if (meta.role_courses) ranks.push("Degustatore");

            document.getElementById('judge-name').textContent = fullName || user.email;
            document.getElementById('judge-rank').textContent = ranks.join(" â€¢ ");
            if (meta.bjcp_id) document.getElementById('judge-id').textContent = `BJCP ID: ${meta.bjcp_id}`;
            document.getElementById('judge-email').textContent = user.email;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('print-area').style.display = 'block';
        }

        loadSheet();

        // 1. ELIMINAZIONE
        document.getElementById('btn-delete').addEventListener('click', async () => {
            if(!confirm("âš ï¸ Sei sicuro di voler eliminare questa scheda definitivamente?")) return;

            const { error } = await supabase
                .from('tasting_notes')
                .delete()
                .eq('id', noteId);

            if (error) {
                alert("Errore eliminazione: " + error.message);
            } else {
                alert("Scheda eliminata.");
                window.location.href = 'storico.html';
            }
        });

        // 2. DOWNLOAD PDF
        document.getElementById('btn-download').addEventListener('click', () => {
            const element = document.getElementById('print-area');
            const btn = document.getElementById('btn-download');
            
            btn.textContent = "Generazione...";
            btn.disabled = true;

            const opt = {
                margin:       10,
                filename:     `Scheda_${document.getElementById('pdf-beer').textContent}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.textContent = "ðŸ“¥ Scarica PDF";
                btn.disabled = false;
            });
        });
    </script>
</body>
</html>